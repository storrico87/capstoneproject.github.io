YUI.add("album-route",function(e){function s(e){s.superclass.constructor.call(this,e)}var t=require("lib/helpers/type-validator"),n=25,r=50,i=100;e.Routes[this.name]=s,e.extend(s,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(s){var o=this,u={},a,f="/photos/"+s.params.nsid_or_path_alias+"/albums/"+s.params.set_id+"/",l=s.params&&s.params.photo_id,c=l?i:n,h=this.getPageNumber(s),p=s.headers?s.headers["user-agent"]:!1,d=s.query?s.query:{},v,m=!1,g=s.params.nsid_or_path_alias,y=[],b;return p&&p.match(/^Twitterbot/i)!==null&&(m=!0),u.id=s.params.set_id,a={page:i/c*(h-1)+1,perPage:c,withPhotoId:l},y.push(this.appContext.getModel("set-models",u,a)),this.appContext.getViewer().signedIn||s.probableUser?y.push(this.appContext.getModel("person-preferences-models",this.appContext.getViewer().signedIn?this.appContext.getViewer().nsid:s.probableUser)):v=d.layout?d.layout:"story",e.Promise.all(y).catch(function(e){if(e.getModelFailure&&s.probableUser)return s.probableUser=null,[];throw e}).then(function(n){var u=0,c=n[0];n[1]&&(v=n[1].getValue("albumViewLayoutPref"));if(YUI.Env.isServer){u=Math.ceil(c.getValue("totalCount")/i);if(h>u&&a.page>1&&!isNaN(parseInt(s.params.page_number,10)))return e.Promise.resolve({redirect:f.replace(/page[0-9]+/,"")})}if(g!==c.getValue("owner").getValue(t.nsid(g)?"id":"pathAlias"))return o.onRouteRejected({message:"Album "+c.getValue("id")+" is not owned by "+g},s);if(l){var p=c.getValue("photoPageList");b=p.getPageOf({id:l},r);if(b===-1||p.getNextIncompletePage(a)===b)return a.forceAPICall=!0,p.getPage(a).then(function(e){return h=Math.ceil(p.getPageOf({id:l},r)*r/i),h===0&&(h=0),b=h,o.onRouteResolved(c,h,b,f,l,m,v,g)},function(e){return e.code===2?(h=o.getPageNumber(s),b=i/r*(h-1)+1,o.onRouteResolved(c,h,b,f,l,m,v,g)):o.onRouteRejected(e,s)});h=Math.ceil(p.getPageOf({id:l},r)*r/i),b=h}else b=i/r*(h-1)+1;return o.onRouteResolved(c,h,b,f,l,m,v,g)}).catch(function(t){if(t.code===2)return e.Promise.resolve({redirect:f});if(t.timeout){var n={view:"empty-album-page-view",layout:"scrolling",params:{}};return e.Promise.resolve(n)}return o.onRouteRejected(t,s)})},onRouteResolved:function(t,n,s,o,u,a,f,l){var c={idAttribute:"id",page:s,perPage:u?i:r,viewPageSizeForShare:i,nominalPage:n};return this.appContext.flipper.isFlipped("enable-album-pagination")&&(c.viewPageSize=i),e.Promise.resolve({view:"album-page-view",layout:"scrolling",title:t.getValue("title"),params:{albumId:t.id,nsid:t.getValue("owner").getValue("nsid"),baseURL:o,isTwitterbot:a,albumPhotoListLayoutStyle:f,withPhotoId:u,nsidOrPathAlias:l,pageParams:c}})},onRouteRejected:function(t,n){var r="Couldn't load album page";t.message&&(r+=": "+t.message);if(t.fatal)throw t;return this.displayRouteErrors(n,new e.RouteError(404,r))}})},"@VERSION@",{requires:["flickr-route","flickr-promise","set-models","person-preferences-models"]});
